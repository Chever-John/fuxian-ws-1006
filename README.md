# WebSocket 1006 错误测试工具

最近在研究一下 websocket 这个有意思的东西，可以看看其在 分布式 or 其他系统的可能的应用。

这个项目用于复现和理解 WebSocket 1006 错误（异常关闭）的各种场景。

## 错误码 1006 说明

**1006 Abnormal Closure** 表示连接异常关闭，没有收到正常的关闭帧。这通常发生在：

- 服务器进程崩溃或被强制终止
- 网络连接中断
- 代理服务器超时
- 服务器直接关闭TCP连接而非正常关闭WebSocket

## 项目结构

- `server.go` - Go语言编写的WebSocket服务器，模拟各种1006错误场景
- `index.html` - 前端测试页面，用于连接不同场景并观察结果
- `go.mod` - Go模块依赖文件

## 快速开始

1. 安装依赖：
```bash
go mod download
```

2. 启动服务器：
```bash
go run server.go
```

3. 打开浏览器访问：http://localhost:8080

## 测试场景

### 场景1: 服务器异常断开
服务器收到消息后直接关闭底层TCP连接，不发送WebSocket关闭帧。这模拟了服务器异常终止的情况。

### 场景2: 读取超时
服务器在10秒后停止响应，触发读取超时。这模拟了服务器挂起或无响应的情况。

### 场景3: 服务器崩溃
服务器在5-15秒内随机崩溃（panic）。这模拟了服务器进程意外终止的情况。

### 场景4: 代理超时
模拟长时间无数据传输导致的代理超时（约60秒）。这在使用反向代理或负载均衡器时常见。

### 正常场景
包含心跳机制的正常WebSocket连接，用于对比。

## 如何测试

1. 选择一个场景，点击"连接"按钮
2. 观察连接状态和日志输出
3. 可以手动发送心跳或启动自动心跳
4. 等待错误发生，观察错误码和关闭原因

## 解决方案

针对1006错误，建议采取以下措施：

1. **实现心跳机制**：定期发送ping/pong消息保持连接活跃
2. **自动重连**：检测到1006错误后自动尝试重新连接
3. **超时设置**：合理设置读写超时时间
4. **优雅关闭**：确保服务器正确发送关闭帧
5. **代理配置**：调整反向代理的超时设置

## 依赖

- Go 1.21+
- github.com/gorilla/websocket v1.5.1 # fuxian-ws-1006
